# ğŸ“‹ Profile & Notifications Module

ĞŸÑŠĞ»Ğ½Ğ° Ğ¸Ğ¼Ğ¿Ğ»ĞµĞ¼ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ñ Ğ½Ğ° Ğ¼Ğ¾Ğ´ÑƒĞ» "ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ» & ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸" Ñ Ñ†ĞµĞ½Ñ‚ÑŠÑ€ Ğ·Ğ° Ğ¸Ğ·Ğ²ĞµÑÑ‚Ğ¸Ñ.

## ğŸ¯ Features

### âœ… ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ» (ĞĞ±Ñ‰ Ğ¿Ñ€ĞµĞ³Ğ»ĞµĞ´)
- ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»Ğ½Ğ° ĞºĞ°Ñ€Ñ‚Ğ° Ñ avatar, Ğ¸Ğ¼Ğµ, email, Ñ€Ğ¾Ğ»Ğ¸
- Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ¸ (Ğ¡Ğ¸Ğ³Ğ½Ğ°Ğ»Ğ¸/Ğ˜Ğ´ĞµĞ¸/Ğ¡Ğ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ/ĞšĞ¾Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸)
- Ğ‘ÑŠÑ€Ğ·Ğ¸ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ
- Timeline Ğ½Ğ° Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚

### âš™ï¸ ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸
- **Ğ›Ğ¸Ñ‡Ğ½Ğ¸ Ğ´Ğ°Ğ½Ğ½Ğ¸**: Ğ¸Ğ¼Ğµ, avatar, bio, Ñ€Ğ°Ğ¹Ğ¾Ğ½
- **ĞŸĞ¾Ğ²ĞµÑ€Ğ¸Ñ‚ĞµĞ»Ğ½Ğ¾ÑÑ‚**: Ğ¿ÑƒĞ±Ğ»Ğ¸Ñ‡ĞµĞ½ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ», Ğ¿Ğ¾ĞºĞ°Ğ·Ğ²Ğ°Ğ½Ğµ Ñ€Ğ¾Ğ»Ñ/Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚, Ñ‚ÑŠÑ€ÑĞµĞ½Ğµ
- **ĞŸÑ€ĞµĞ´Ğ¿Ğ¾Ñ‡Ğ¸Ñ‚Ğ°Ğ½Ğ¸Ñ**: Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Ğ´Ğ°Ñ‚Ğ°, Ñ‡Ğ°ÑĞ¾Ğ²Ğ° Ğ·Ğ¾Ğ½Ğ°, Ğ¸Ğ·Ğ³Ğ»ĞµĞ´, Ñ‚ĞµĞ¼Ğ°
- **Ğ•Ğ·Ğ¸Ğº Ğ¸ Ğ´Ğ¾ÑÑ‚ÑŠĞ¿Ğ½Ğ¾ÑÑ‚**: ĞµĞ·Ğ¸Ğº, font scale, Ğ½Ğ°Ğ¼Ğ°Ğ»ĞµĞ½Ğ¸ Ğ°Ğ½Ğ¸Ğ¼Ğ°Ñ†Ğ¸Ğ¸

### ğŸ”” Ğ˜Ğ·Ğ²ĞµÑÑ‚Ğ¸Ñ
- **Ğ¦ĞµĞ½Ñ‚ÑŠÑ€**: ÑĞ¿Ğ¸ÑÑŠĞº Ñ Ğ¸Ğ·Ğ²ĞµÑÑ‚Ğ¸Ñ, Ñ„Ğ¸Ğ»Ñ‚Ñ€Ğ¸, mark as read, delete
- **ĞšĞ°Ğ½Ğ°Ğ»Ğ¸**: Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ Ğ·Ğ° in-app/email/push Ğ¿Ğ¾ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ğ¸
- **Digest**: Ğ´Ğ½ĞµĞ²ĞµĞ½/ÑĞµĞ´Ğ¼Ğ¸Ñ‡ĞµĞ½/Ğ¼ĞµÑĞµÑ‡ĞµĞ½ Ğ¾Ğ±Ğ·Ğ¾Ñ€
- **Ğ¢Ğ¸Ñ…Ğ¸ Ñ‡Ğ°ÑĞ¾Ğ²Ğµ**: Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´ Ğ±ĞµĞ· email/push

### ğŸ“¦ GDPR
- **Ğ•ĞºÑĞ¿Ğ¾Ñ€Ñ‚**: Ğ¿ÑŠĞ»ĞµĞ½ ĞµĞºÑĞ¿Ğ¾Ñ€Ñ‚ Ğ½Ğ° Ğ´Ğ°Ğ½Ğ½Ğ¸ Ğ² JSON (rate limit: 2/Ğ´ĞµĞ½)
- **Ğ˜Ğ·Ñ‚Ñ€Ğ¸Ğ²Ğ°Ğ½Ğµ**: Ğ¿Ğ»Ğ°Ğ½Ğ¸Ñ€Ğ°Ğ½Ğ¾ Ğ¸Ğ·Ñ‚Ñ€Ğ¸Ğ²Ğ°Ğ½Ğµ ÑĞ»ĞµĞ´ 30 Ğ´Ğ½Ğ¸

## ğŸš€ ĞšĞ°Ğº Ğ´Ğ° Ñ‚ĞµÑÑ‚Ğ²Ğ°Ğ¼

### 1. Ğ¡Ñ‚Ğ°Ñ€Ñ‚Ğ¸Ñ€Ğ°Ğ¹ dev server
```bash
cd apps/web
pnpm dev
```

### 2. Seed Ñ‚ĞµÑÑ‚Ğ¾Ğ²Ğ¸ Ğ¸Ğ·Ğ²ĞµÑÑ‚Ğ¸Ñ
```bash
node apps/web/scripts/seed-notifications.js
```

### 3. ĞÑ‚Ğ²Ğ¾Ñ€Ğ¸ Ğ±Ñ€Ğ°ÑƒĞ·ÑŠÑ€Ğ°
- ĞÑ‚Ğ¸Ğ´Ğ¸ Ğ½Ğ° http://localhost:3003
- Login Ñ `st_ivan_trilovski@pgtmbg.com`
- ĞĞ°Ğ²Ğ¸Ğ³Ğ¸Ñ€Ğ°Ğ¹ Ğ´Ğ¾ `/bg/me`

### 4. Ğ¢ĞµÑÑ‚Ğ²Ğ°Ğ¹ tabs
- **ĞĞ±Ñ‰ Ğ¿Ñ€ĞµĞ³Ğ»ĞµĞ´**: Ğ²Ğ¸Ğ¶ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ», ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ¸, Ğ±ÑŠÑ€Ğ·Ğ¸ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ
- **ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸**: Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ°Ğ¹ Ğ´Ğ°Ğ½Ğ½Ğ¸, privacy, preferences
- **Ğ˜Ğ·Ğ²ĞµÑÑ‚Ğ¸Ñ**: Ğ²Ğ¸Ğ¶ ÑĞ¿Ğ¸ÑÑŠĞº, Ğ¼Ğ°Ñ€ĞºĞ¸Ñ€Ğ°Ğ¹ Ğ¿Ñ€Ğ¾Ñ‡ĞµÑ‚ĞµĞ½Ğ¸, settings
- **Ğ”Ğ°Ğ½Ğ½Ğ¸**: Ğ·Ğ°ÑĞ²Ğ¸ ĞµĞºÑĞ¿Ğ¾Ñ€Ñ‚ (Ñ‡Ğ°ĞºĞ°Ğ¹ ~2 ÑĞµĞº), ÑĞ²Ğ°Ğ»Ğ¸

## ğŸ“ Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° Ğ½Ğ° Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²ĞµÑ‚Ğµ

```
apps/web/src/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ [locale]/me/
â”‚   â”‚   â””â”€â”€ page.tsx                    # Main profile page with tabs
â”‚   â””â”€â”€ api/
â”‚       â”œâ”€â”€ me/
â”‚       â”‚   â”œâ”€â”€ profile/route.ts        # GET/PUT profile
â”‚       â”‚   â”œâ”€â”€ notifications/          # Notifications APIs
â”‚       â”‚   â”œâ”€â”€ notification-prefs/     # Settings APIs
â”‚       â”‚   â””â”€â”€ export/                 # GDPR export APIs
â”‚       â””â”€â”€ users/[userId]/route.ts     # Public profile
â”‚
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ profile/
â”‚   â”‚   â”œâ”€â”€ ProfileOverview.tsx         # Overview tab
â”‚   â”‚   â”œâ”€â”€ SettingsPanel.tsx           # Settings tab wrapper
â”‚   â”‚   â”œâ”€â”€ PersonalDataForm.tsx        # Personal data form
â”‚   â”‚   â”œâ”€â”€ PrivacySettings.tsx         # Privacy toggles
â”‚   â”‚   â”œâ”€â”€ PreferencesForm.tsx         # Preferences form
â”‚   â”‚   â”œâ”€â”€ AccessibilitySettings.tsx   # A11y settings
â”‚   â”‚   â”œâ”€â”€ NotificationsPanel.tsx      # Notifications tab wrapper
â”‚   â”‚   â””â”€â”€ DataPanel.tsx               # GDPR export/delete
â”‚   â”‚
â”‚   â””â”€â”€ notifications/
â”‚       â”œâ”€â”€ NotificationCenter.tsx      # Notifications list
â”‚       â”œâ”€â”€ NotificationBell.tsx        # Header bell dropdown
â”‚       â”œâ”€â”€ ChannelSettings.tsx         # Channel preferences
â”‚       â”œâ”€â”€ DigestSettings.tsx          # Digest preferences
â”‚       â””â”€â”€ QuietHoursSettings.tsx      # Quiet hours settings
â”‚
â””â”€â”€ lib/
    â””â”€â”€ get-id-token.ts                 # Token helper
```

## ğŸ¨ Design System

### Colors
- Primary: `#6366F1` (Indigo)
- Success: `#22C55E` (Green)
- Warning: `#F59E0B` (Amber)
- Danger: `#EF4444` (Red)

### Components
- Cards with `rounded-lg` + `border` + `shadow-sm`
- Buttons with `hover:` states + `transition-colors`
- Forms with auto-save + success indicators
- Loading states with `Loader2` spinner

## ğŸ“Š Database Schema

### Collections

#### `users`
```json
{
  "email": "user@example.com",
  "name": "Ğ˜Ğ¼Ğµ",
  "avatar_url": "https://...",
  "bio": "ĞšÑ€Ğ°Ñ‚ĞºĞ¾ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ",
  "area_id": "plovdiv_center",
  "locale": "bg",
  "timezone": "Europe/Sofia",
  "date_format": "DD.MM.YYYY",
  "map_default": "list",
  "theme": "system",
  "roles": ["citizen"],
  "a11y": {
    "fontScale": 100,
    "reduceMotion": false
  },
  "privacy": {
    "public_profile": true,
    "show_role": true,
    "show_activity": true,
    "searchable": true,
    "show_verified_email": true
  }
}
```

#### `notifications`
```json
{
  "user_id": "user_123",
  "category": "signals",
  "type": "status_change",
  "title": "ĞĞ¾Ğ² ÑÑ‚Ğ°Ñ‚ÑƒÑ",
  "body": "ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ...",
  "icon": "ğŸš©",
  "link": "/bg/signals/123",
  "created_at": 1698765432000,
  "read_at": null,
  "delivered": {
    "inapp": true,
    "email": false,
    "push": false
  }
}
```

#### `notification_prefs`
```json
{
  "channels": {
    "system": { "inapp": true, "email": true, "push": false },
    "signals": { "inapp": true, "email": false, "push": true },
    "ideas": { "inapp": true, "email": false, "push": false },
    "events": { "inapp": true, "email": true, "push": true }
  },
  "digest": {
    "daily": "09:00",
    "weekly": { "day": 1, "time": "09:00" },
    "monthly": null
  },
  "quiet_hours": {
    "enabled": true,
    "from": "22:00",
    "to": "07:00"
  }
}
```

#### `exports`
```json
{
  "user_id": "user_123",
  "status": "ready",
  "requested_at": 1698765432000,
  "ready_at": 1698765435000,
  "expires_at": 1699370232000,
  "data": "{ ... }",
  "size_bytes": 45678
}
```

## ğŸ”’ Security & Privacy

### RBAC
- Guest: no access to `/me`
- Citizen: full access to own profile
- Moderator/Admin: cannot edit others' profiles

### Privacy Rules
- Email/phone NEVER shown publicly
- `public_profile = false` â†’ 403 on `/u/:id`
- `show_role = false` â†’ role badge hidden
- `show_activity = false` â†’ activity hidden

### Rate Limits
- Export: 2/day
- API calls: 100/hour per endpoint

## âœ… Acceptance Criteria

- [x] Profile overview shows stats and activity
- [x] Personal data form with validation
- [x] Privacy settings with auto-save
- [x] Preferences apply immediately (theme, font scale)
- [x] Notification center with filters and actions
- [x] Channel settings per category
- [x] Digest and quiet hours configuration
- [x] GDPR export (request â†’ poll â†’ download)
- [x] All text in Bulgarian
- [x] Mobile responsive
- [x] Loading states everywhere
- [x] Error handling

## ğŸ› Known Issues / TODO

- [ ] Avatar upload (currently placeholder)
- [ ] Real-time notifications via WebSocket
- [ ] Email templates for digest
- [ ] Account deletion workflow (step-up auth)
- [ ] Public profile page `/u/:id`
- [ ] Activity timeline data fetching

## ğŸ“ Testing Checklist

### Profile
- [ ] Edit name, bio â†’ saves successfully
- [ ] Name validation (2-100 chars)
- [ ] Bio validation (max 200 chars)

### Privacy
- [ ] Toggle settings â†’ auto-saves
- [ ] Public profile OFF â†’ /u/:id returns 403
- [ ] Show role OFF â†’ badge hidden

### Preferences
- [ ] Change theme â†’ applies immediately
- [ ] Font scale â†’ text size changes
- [ ] Reduce motion â†’ animations stop

### Notifications
- [ ] List shows all notifications
- [ ] Filter by category works
- [ ] Mark as read â†’ badge decrements
- [ ] Delete notification â†’ removes from list
- [ ] Channel settings save correctly
- [ ] Digest settings save correctly
- [ ] Quiet hours save correctly

### GDPR
- [ ] Request export â†’ status: pending
- [ ] Wait ~2 sec â†’ status: ready
- [ ] Download â†’ JSON file downloads
- [ ] 3rd request same day â†’ 429 error

## ğŸ‰ Done!

ĞœĞ¾Ğ´ÑƒĞ»ÑŠÑ‚ Ğµ Ğ½Ğ°Ğ¿ÑŠĞ»Ğ½Ğ¾ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ĞµĞ½ Ğ¸ Ğ³Ğ¾Ñ‚Ğ¾Ğ² Ğ·Ğ° production ÑĞ»ĞµĞ´:
1. WebSocket real-time notifications
2. Avatar upload functionality
3. Email delivery service
4. Account deletion with step-up auth

**Enjoy! ğŸš€**
