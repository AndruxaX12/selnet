<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Подаване на нов сигнал - Моят Ботевград</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Leaflet.js CSS (за картата) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    <!-- Шрифт Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Стил за картата в тази страница */
        #map-submit { 
            height: 400px; /* 400px височина */
            border-radius: 0.75rem; /* rounded-xl */
            z-index: 10;
        }
        
        /* Стилизиран превключвател (toggle switch) */
        .toggle-bg:after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            background-color: white;
            width: 1.25rem; /* w-5 */
            height: 1.25rem; /* h-5 */
            border-radius: 9999px; /* rounded-full */
            transition: transform 0.2s ease-in-out;
        }
        input:checked + .toggle-bg:after {
            transform: translateX(100%);
        }
        input:checked + .toggle-bg {
            background-color: #16a34a; /* green-600 */
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col min-h-screen">

    <!-- 1. Хедър -->
    <header class="flex justify-between items-center p-3 border-b border-gray-200 z-50 bg-white">
        <!-- Ляво: Лого и Заглавие -->
        <div class="flex items-center space-x-8">
            <div class="flex items-center space-x-2">
                <!-- Икона Лого -->
                <a href="index.html" class="flex items-center space-x-2">
                    <svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect width="40" height="40" rx="8" fill="#E0FBE0"/>
                        <path d="M13.5 13.1111V16.8889H10V13.1111H13.5ZM18.75 13.1111V16.8889H15.25V13.1111H18.75ZM24 13.1111V16.8889H20.5V13.1111H24ZM29.25 13.1111V16.8889H25.75V13.1111H29.25ZM13.5 18.7778V22.5556H10V18.7778H13.5ZM18.75 18.7778V22.5556H15.25V18.7778H18.75ZM24 18.7778V22.5556H20.5V18.7778H24ZM29.25 18.7778V22.5556H25.75V18.7778H29.25ZM13.5 24.4444V28.2222H10V24.4444H13.5ZM18.75 24.4444V28.2222H15.25V24.4444H18.75ZM24 24.4444V28.2222H20.5V24.4444H24Z" fill="#006400"/>
                    </svg>
                    <span class="text-xl font-bold text-gray-800">Моят Ботевград</span>
                </a>
            </div>
            <nav class="hidden md:flex space-x-6">
                <a href="index.html" class="font-medium text-gray-600 hover:text-green-600 transition-colors">Всички сигнали</a>
            </nav>
        </div>
        
        <!-- Дясно: Бутон Влез -->
        <div>
            <div class="flex items-center space-x-6">
                <!-- Бутон за нотификации -->
                <button class="relative p-1 rounded-full text-gray-500 hover:text-gray-800 focus:outline-none">
                    <span class="absolute top-0 right-0 h-2 w-2 rounded-full bg-red-500 border-2 border-white"></span>
                    <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M14.857 17.082a23.848 23.848 0 0 0 5.454-1.31A8.967 8.967 0 0 1 18 9.75V9A6 6 0 0 0 6 9v.75a8.967 8.967 0 0 1-2.312 6.022c1.733.64 3.56 1.085 5.455 1.31m5.714 0a24.255 24.255 0 0 1-5.714 0m5.714 0a3 3 0 1 1-5.714 0" />
                    </svg>
                </button>
                
                <a href="#" class="font-semibold text-gray-700 hover:text-green-600 text-sm transition-colors">
                    Моите сигнали
                </a>
                
                <!-- Икона-аватар за профила -->
                <div class="flex items-center space-x-2">
                    <span class="inline-block h-8 w-8 overflow-hidden rounded-full bg-gray-100">
                        <svg class="h-full w-full text-gray-300" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M24 20.993V24H0v-2.996A14.977 14.977 0 0112.004 15c4.904 0 9.26 2.354 11.996 5.993zM16.002 8.999a4 4 0 11-8 0 4 4 0 018 0z" />
                        </svg>
                    </span>
                    <span class="font-semibold text-gray-900 text-sm">
                        Иван Иванов
                    </span>
                </div>
            </div>
        </div>
    </header>

    <!-- 2. Под-хедър (заглавие на страницата) -->
    <div class="bg-white shadow-md border-t border-gray-100 z-20">
        <div class="container mx-auto max-w-4xl px-4 sm:px-6 lg:px-8">
            <div class="flex items-center space-x-3 h-14">
                <a href="index.html" class="text-gray-500 hover:text-gray-800">
                    <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                    </svg>
                </a>
                <h1 class="text-xl font-semibold text-gray-900">
                    Подаване на нов сигнал
                </h1>
            </div>
        </div>
    </div>

    <!-- 3. Главно съдържание (Форма) -->
    <!-- ПРОМЯНА: Връщаме <main> да бъде само контейнер -->
    <main class="container mx-auto max-w-4xl p-4 sm:p-6 lg:p-8 flex-1">
        
        <!-- ПРОМЯНА: Добавен border border-gray-200 за по-ясно "подчертаване" на wrapper-a -->
        <div class="bg-white p-6 sm:p-8 rounded-xl shadow-lg border border-gray-200">
            <form class="space-y-6">
                
                <!-- Заглавие на сигнала -->
                <div>
                    <!-- ПРОМЯНА: Увеличено отстояние от mb-1 на mb-2 -->
                    <label for="signal-title" class="block text-sm font-medium text-gray-700 mb-2">Заглавие на сигнала</label>
                    <!-- ПРОМЯНА: Добавен placeholder:text-gray-400 и bg-gray-50 -->
                    <input type="text" id="signal-title" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-green-500 focus:ring-green-500 placeholder:text-gray-400 bg-gray-50" placeholder="Въведи заглавие на сигнала...">
                </div>

                <!-- Тип и Населено място (на един ред) -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Тип на категория -->
                    <div>
                        <!-- ПРОМЯНА: Увеличено отстояние от mb-1 на mb-2 -->
                        <label for="signal-category" class="block text-sm font-medium text-gray-700 mb-2">Тип на категория</label>
                        <!-- ПРОМЯНА: Добавен bg-gray-50 -->
                        <select id="signal-category" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-green-500 focus:ring-green-500 bg-gray-50">
                            <option value="">Избери категория...</option>
                            <option value="road">Път/Дупка</option>
                            <option value="lighting">Осветление</option>
                            <option value="waste">Сметище/Отпадъци</option>
                            <option value="other">Друго</option>
                        </select>
                    </div>

                    <!-- Населено място -->
                    <div>
                        <!-- ПРОМЯНА: Увеличено отстояние от mb-1 на mb-2 -->
                        <label for="signal-location" class="block text-sm font-medium text-gray-700 mb-2">Населено място</label>
                        <!-- ПРОМЯНА: Добавен bg-gray-50 -->
                        <select id="signal-location" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-green-500 focus:ring-green-500 bg-gray-50">
                            <option value="">Избери населено място...</option>
                            <option value="botevgrad">гр. Ботевград</option>
                            <option value="vrachesh">с. Врачеш</option>
                            <option value="trudovets">с. Трудовец</option>
                        </select>
                    </div>
                </div>

                <!-- Местоположение (Адрес) -->
                <div>
                    <!-- ПРОМЯНА: Увеличено отстояние от mb-1 на mb-2 -->
                    <label for="signal-address" class="block text-sm font-medium text-gray-700 mb-2">Местоположение (въведи адрес)</label>
                    <!-- ПРОМЯНА: Добавен placeholder:text-gray-400 и bg-gray-50 -->
                    <input type="text" id="signal-address" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-green-500 focus:ring-green-500 placeholder:text-gray-400 bg-gray-50" placeholder="Въведи адрес...">
                    <!-- ПРОМЯНА: Увеличено отстояние от mt-1 на mt-2 -->
                    <p class="mt-2 text-xs text-gray-500">...или избери с клик върху картата по-долу:</p>
                </div>

                <!-- Карта за избор -->
                <!-- ПРОМЯНА: Върната 'shadow-lg' -->
                <div id="map-submit" class="w-full bg-gray-200 z-10 rounded-xl shadow-lg"></div>

                <!-- Описание на сигнала -->
                <div>
                    <!-- ПРОМЯНА: Увеличено отстояние от mb-1 на mb-2 -->
                    <label for="signal-description" class="block text-sm font-medium text-gray-700 mb-2">Описание на сигнала</label>
                    <!-- ПРОМЯНА: Добавен placeholder:text-gray-400 и bg-gray-50 -->
                    <textarea id="signal-description" rows="5" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-green-500 focus:ring-green-500 placeholder:text-gray-400 bg-gray-50" placeholder="Опиши сигнала..."></textarea>
                </div>

                <!-- Качване на снимки -->
                <div>
                    <!-- ПРОМЯНА: Увеличено отстояние от mb-1 на mb-2 -->
                    <label class="block text-sm font-medium text-gray-700 mb-2">Снимки / Видео</label>
                    <!-- ПРОМЯНА: Добавен 'bg-gray-50' за лек акцент -->
                    <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-lg bg-gray-50">
                        <div class="space-y-1 text-center">
                            <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true">
                                <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                            <div class="flex text-sm text-gray-600">
                                <label for="file-upload" class="relative cursor-pointer bg-white rounded-md font-medium text-green-600 hover:text-green-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-green-500">
                                    <span>Избор на файл</span>
                                    <input id="file-upload" name="file-upload" type="file" class="sr-only" multiple>
                                </label>
                                <p class="pl-1">или плъзни и пусни</p>
                            </div>
                            <p class="text-xs text-gray-500">Видео, PNG, JPG (до 50MB)</p>
                        </div>
                    </div>
                </div>

                <!-- Анонимен сигнал (Превключвател) -->
                <!-- ПРОМЯНА: Добавена лека рамка и 'padding' за визуално отделяне -->
                <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                    <span class="text-sm font-medium text-gray-700">Подай сигнала анонимно</span>
                    <label for="anonymous-toggle" class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="anonymous-toggle" class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-focus:ring-2 peer-focus:ring-green-300 toggle-bg transition-colors"></div>
                    </label>
                </div>

                <!-- Бутон за изпращане -->
                <div>
                    <!-- ПРОМЯНА: Върнати 'shadow-md' и 'hover:scale-105' -->
                    <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-md text-lg font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-all transform hover:scale-105">
                        Изпрати сигнал
                    </button>
                </div>

            </form>
        </div>
    </main>

    <!-- 4. Футър -->
    <footer class="bg-white border-t border-gray-200 mt-10">
        <div class="container mx-auto max-w-7xl py-8 px-4 sm:px-6 lg:px-8 flex flex-col md:flex-row justify-between items-center text-sm text-gray-600">
            <div class="mb-4 md:mb-0">
                <span>Copyright © 2025 Моят Ботевград от ДИМИТРИ ТЕХ ООД.</span>
            </div>
            <div class="flex space-x-6">
                <a href="#" class="hover:text-green-600">Архив сигнали</a>
                <a href="#" class="hover:text-green-600">За платформата</a>
                <a href="#" class="hover:text-green-600">Условия за ползване</a>
                <a href="#" class="hover:text-green-600">Защита на личните данни</a>
            </div>
        </div>
    </footer>

    <!-- Leaflet JS (за картата) -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    
    <!-- JavaScript за картата и формата -->
    <script>
        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyBOtsHBzYm3JeZ-V5mRZjBh3DcQ-RBhGQI",
            authDomain: "selnet-ab187.firebaseapp.com",
            projectId: "selnet-ab187",
            storageBucket: "selnet-ab187.firebasestorage.app",
            messagingSenderId: "932806802011",
            appId: "1:932806802011:web:fe94012a84fdc76498dd7e"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // State
        let currentUser = null;
        let selectedLat = null;
        let selectedLng = null;

        // Listen for auth state
        auth.onAuthStateChanged((user) => {
            currentUser = user;
            // Update header with user info
            const userNameEl = document.querySelector('.text-gray-900.text-sm');
            if (userNameEl && user) {
                userNameEl.textContent = user.displayName || user.email?.split('@')[0] || 'Потребител';
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            // Initialize map
            const map = L.map('map-submit').setView([42.906, 23.791], 14);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            let marker;

            // Map click handler
            map.on('click', function(e) {
                selectedLat = e.latlng.lat;
                selectedLng = e.latlng.lng;
                
                if (marker) {
                    map.removeLayer(marker);
                }
                
                marker = L.marker(e.latlng).addTo(map);
                marker.bindPopup(`<b>Избрана локация</b><br>Координати: ${selectedLat.toFixed(6)}, ${selectedLng.toFixed(6)}`).openPopup();
                
                // Update hidden fields or address
                const addressField = document.getElementById('signal-address');
                if (addressField && !addressField.value.trim()) {
                    addressField.placeholder = `Координати: ${selectedLat.toFixed(6)}, ${selectedLng.toFixed(6)}`;
                }
            });

            // Form submission
            const form = document.querySelector('form');
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const submitBtn = form.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                
                try {
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<span class="animate-pulse">Изпращане...</span>';
                    
                    // Get form values
                    const title = document.getElementById('signal-title').value.trim();
                    const categoryValue = document.getElementById('signal-category').value;
                    const district = document.getElementById('signal-location').value;
                    const address = document.getElementById('signal-address').value.trim();
                    const description = document.getElementById('signal-description').value.trim();
                    const isAnonymous = document.getElementById('anonymous-toggle').checked;
                    
                    // Category mapping
                    const categoryMap = {
                        'road': 'Пътища и тротоари',
                        'lighting': 'Осветление',
                        'waste': 'отпадъци',
                        'other': 'Друго'
                    };
                    const category = categoryMap[categoryValue] || 'Друго';
                    
                    // District mapping
                    const districtMap = {
                        'botevgrad': 'гр. Ботевград',
                        'vrachesh': 'с. Врачеш',
                        'trudovets': 'с. Трудовец'
                    };
                    const districtLabel = districtMap[district] || district;
                    
                    // Validation
                    if (!title) {
                        alert('Моля, въведете заглавие на сигнала');
                        return;
                    }
                    if (!categoryValue) {
                        alert('Моля, изберете категория');
                        return;
                    }
                    if (!district) {
                        alert('Моля, изберете населено място');
                        return;
                    }
                    if (!description) {
                        alert('Моля, въведете описание на сигнала');
                        return;
                    }
                    
                    // Prepare author data
                    const authorData = isAnonymous ? {
                        author_id: 'anonymous',
                        author_name: null,
                        author_email: null,
                        author_photo: null,
                        isAnonymous: true
                    } : {
                        author_id: currentUser?.uid || 'anonymous',
                        author_name: currentUser?.displayName || currentUser?.email?.split('@')[0] || null,
                        author_email: currentUser?.email || null,
                        author_photo: currentUser?.photoURL || null,
                        isAnonymous: false
                    };
                    
                    // Create signal document
                    const signalData = {
                        title,
                        description,
                        desc: description,
                        category,
                        district: districtLabel,
                        settlementLabel: districtLabel,
                        address: address || districtLabel,
                        location: {
                            lat: selectedLat || 42.906,
                            lng: selectedLng || 23.791,
                            address: address || districtLabel
                        },
                        geo: {
                            lat: selectedLat || 42.906,
                            lng: selectedLng || 23.791
                        },
                        status: 'novo',
                        priority: 'normal',
                        ...authorData,
                        photos: [],
                        createdAt: Date.now(),
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString(),
                        comments_count: 0,
                        votes_support: 0,
                        watchers: 0
                    };
                    
                    // Save to Firestore
                    const docRef = await db.collection('signals').add(signalData);
                    
                    alert('Сигналът е изпратен успешно!');
                    
                    // Redirect to signal page
                    window.location.href = `/signals/${docRef.id}`;
                    
                } catch (error) {
                    console.error('Error submitting signal:', error);
                    alert('Грешка при изпращане на сигнала. Моля, опитайте отново.');
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                }
            });
        });
    </script>
</body>
</html>